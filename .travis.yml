sudo: required

language: java

jdk:
- oraclejdk7

services:
- docker



env:
  DOCKER_COMPOSE_VERSION: 1.5.1

before_install:
- sudo rm /usr/local/bin/docker-compose
- curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
- chmod +x docker-compose
- sudo mv docker-compose /usr/local/bin



before_script:
# determine tag for Docker images based on current commit
- echo $(if [ -n "$TRAVIS_TAG" ]; then echo $TRAVIS_TAG;elif [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest";else echo $TRAVIS_BRANCH;fi) > tag
# if commit tag is given on master branch, also push Docker images as 'latest'
- if [ -n "$TRAVIS_TAG" ] && [ "$TRAVIS_BRANCH" == "master" ]; then touch tag-latest; fi

script:
# run unit tests
- ./gradlew clean test
# build JARs
- ./gradlew clean build
# build Docker images
- 'docker build -f Dockerfile_middletier -t "$RSS_MIDDLETIER_IMAGE:$(cat tag)" .'
- 'docker build -f Dockerfile_edge -t "$RSS_EDGE_IMAGE:$(cat tag)" .'
# run integration test
- ./test/smoketest.sh
# push Docker images to Docker Hub
- '$(cat test-result) && docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"'
- '$(cat test-result) && docker push "$RSS_MIDDLETIER_IMAGE:$(cat tag)"'
- '$(cat test-result) && docker push "$RSS_EDGE_IMAGE:$(cat tag)"'
- 'if [ -e tag-latest ]; then docker tag "$RSS_MIDDLETIER_IMAGE:$(cat tag)" "$RSS_MIDDLETIER_IMAGE:latest" fi'
- 'if [ -e tag-latest ]; then docker tag "$RSS_EDGE_IMAGE:$(cat tag)" "$RSS_EDGE_IMAGE:latest" fi'
- 'if [ -e tag-latest ]; then docker push "$RSS_MIDDLETIER_IMAGE:latest" fi'
- 'if [ -e tag-latest ]; then docker push "$RSS_EDGE_IMAGE:latest" fi'

# send out notifications by e-mail, slack, ...
# https://docs.travis-ci.com/user/notifications/
